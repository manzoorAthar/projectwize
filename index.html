<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Development Management App</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom font for a clean look */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styles for print view */
        @media print {
            .print\:shadow-none { box-shadow: none !important; }
            .print\:rounded-none { border-radius: 0 !important; }
            .print\:p-0 { padding: 0 !important; }
            .print\:text-2xl { font-size: 1.5rem !important; }
            .print\:mb-4 { margin-bottom: 1rem !important; }
            .print\:grid-cols-1 { grid-template-columns: 1fr !important; }
            .print\:gap-4 { gap: 1rem !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:border { border-width: 1px !important; border-color: #e5e7eb !important; }
            .print\:text-lg { font-size: 1.125rem !important; }
            .print\:text-base { font-size: 1rem !important; }
            .print\:text-xs { font-size: 0.75rem !important; }
            .print\:ml-2 { margin-left: 0.5rem !important; }
            .print\:w-20 { width: 5rem !important; }
            .print\:h-20 { height: 5rem !important; }
            .print\:hidden { display: none !important; }

            /* Ensure canvases are visible and sized correctly for print */
            #printable-status-chart, #printable-priority-chart {
                display: block !important;
                width: 100% !important;
                height: 250px !important; /* Adjust height for print if needed */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 p-4 sm:p-6 min-h-screen">

    <div id="app-root" class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-8">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">
            Product Development Management
        </h1>

        <!-- User Info and Auth Section -->
        <div class="bg-gray-50 p-4 rounded-lg shadow-inner mb-6">
            <p class="text-sm text-gray-600">
                Your User ID: <span id="user-id" class="font-mono text-blue-700 break-all">Loading...</span>
            </p>
            <p id="user-email-display" class="text-sm text-gray-600 hidden">
                Logged in as: <span id="user-display-name" class="font-semibold text-blue-700"></span>
            </p>
            <div class="mt-4 flex flex-wrap gap-2">
                <button id="auth-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full text-sm transition duration-300">
                    Sign In with Google
                </button>
                <button id="change-pins-button" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full text-sm transition duration-300 hidden">
                    Change PINs
                </button>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Projects by Status Chart -->
            <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Projects by Status</h3>
                <div class="w-full h-[300px] flex items-center justify-center">
                    <canvas id="status-chart"></canvas> <!-- Chart.js will render here -->
                </div>
                <button id="clear-status-filter" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Clear Status Filter
                </button>
            </div>

            <!-- Projects by Priority Chart -->
            <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Projects by Priority</h3>
                <div class="w-full h-[300px] flex items-center justify-center">
                    <canvas id="priority-chart"></canvas> <!-- Chart.js will render here -->
                </div>
                <button id="clear-priority-filter" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Clear Priority Filter
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800">Your Projects</h2>
            <div class="flex space-x-4">
                <button id="add-project-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50">
                    + Add New Project
                </button>
                <button id="create-report-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Create Report
                </button>
            </div>
        </div>

        <!-- Filter and Search Section -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col sm:flex-row gap-4">
            <div class="flex-grow">
                <label for="category-filter" class="block text-gray-700 text-sm font-bold mb-2">Filter by Category:</label>
                <select id="category-filter" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                    <option value="All">All Categories</option>
                    <option value="NPD">NPD</option>
                    <option value="Sourcing">Sourcing</option>
                </select>
            </div>
            <div class="flex-grow">
                <label for="search-projects" class="block text-gray-700 text-sm font-bold mb-2">Search (Project/Manager/Vendor):</label>
                <input type="text" id="search-projects" placeholder="Search by Project, Manager, or Vendor name..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
            </div>
        </div>

        <!-- Sort Section -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <label for="sort-by" class="block text-gray-700 text-sm font-bold mb-2">Sort Projects By:</label>
            <select id="sort-by" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                <option value="none">Default (Creation Order)</option>
                <option value="startDate">Start Date</option>
                <option value="submissionDate">Submission Date</option>
                <option value="projectNumber">Project Number (Creation Order)</option>
                <option value="priority">Priority</option>
            </select>
        </div>

        <!-- Project List Heading -->
        <h2 id="project-list-heading" class="text-2xl font-semibold text-gray-800 mb-6">
            All Projects
        </h2>

        <!-- Project List Container -->
        <div id="project-list-container" class="space-y-4">
            <p class="text-center text-gray-600 text-lg py-10">No projects to display.</p>
        </div>
    </div>

    <!-- Modals -->

    <!-- Project Modal (Add/Edit/View) -->
    <div id="project-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg overflow-y-auto max-h-[90vh]">
            <h2 id="project-modal-title" class="text-2xl font-bold mb-4 text-center text-gray-800">Add New Project</h2>
            <p id="project-modal-error" class="text-red-500 text-sm mb-4 hidden"></p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Project Name:</label>
                    <input type="text" id="project-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Category:</label>
                    <select id="project-category" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="NPD">NPD</option>
                        <option value="Sourcing">Sourcing</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Vendor Name:</label>
                    <input type="text" id="vendor-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Vendor Phone:</label>
                    <input type="text" id="vendor-phone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Vendor Address:</label>
                    <textarea id="vendor-address" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 h-20 resize-y" placeholder="Enter vendor's full address..."></textarea>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Project Manager Name:</label>
                    <input type="text" id="project-manager" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Status:</label>
                    <select id="project-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="Planning">Planning</option>
                        <option value="Development">Development</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Delayed">Delayed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Priority:</label>
                    <select id="project-priority" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="Urgent">Urgent</option>
                        <option value="High">High</option>
                        <option value="Medium-1">Medium-1</option>
                        <option value="Medium-2">Medium-2</option>
                        <option value="Low">Low</option>
                        <option value="Optional">Optional</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Product Segment:</label>
                    <select id="product-segment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="Plastic Storage">Plastic Storage</option>
                        <option value="Steel Storage">Steel Storage</option>
                        <option value="Steel Kitchen Tools">Steel Kitchen Tools</option>
                        <option value="Plastic Kitchen Tools">Plastic Kitchen Tools</option>
                        <option value="Ceramic">Ceramic</option>
                        <option value="Stoneware">Stoneware</option>
                        <option value="PETware">PETware</option>
                        <option value="PET Bottles">PET Bottles</option>
                        <option value="Steel Bottles">Steel Bottles</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Procurement Cost (Ex-Factory Price):</label>
                        <input type="number" step="0.01" id="procurement-cost" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                    </div>
                    <select id="procurement-currency" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="INR">INR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <div class="flex-grow">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Manual MRP:</label>
                        <input type="number" step="0.01" id="mrp" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                    </div>
                    <select id="mrp-currency" class="shadow appearance-none border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="INR">INR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex justify-center gap-4 mt-2">
                    <a href="https://manzoorathar.github.io/mrp-calculator-app-4/" target="_blank" rel="noopener noreferrer">
                        <button type="button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105" id="mrp-calc-btn">
                            Calculate MRP (External)
                        </button>
                    </a>
                    <a href="https://manzoorathar.github.io/mrp_sticker_Generator_3/" target="_blank" rel="noopener noreferrer">
                        <button type="button" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105" id="mrp-sticker-gen-btn">
                            Generate MRP Sticker (External)
                        </button>
                    </a>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Barcode Type:</label>
                    <select id="barcode-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        <option value="EAN-13">EAN-13</option>
                        <option value="UPC-A">UPC-A</option>
                        <option value="Code 39">Code 39</option>
                        <option value="Code 128">Code 128</option>
                        <option value="QR Code">QR Code</option>
                        <option value="Data Matrix">Data Matrix</option>
                        <option value="ITF">ITF</option>
                        <option value="Codabar">Codabar</option>
                        <option value="GS1 DataBar">GS1 DataBar</option>
                        <option value="PDF417">PDF417</option>
                        <option value="Aztec Code">Aztec Code</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Barcode Number:</label>
                    <input type="text" id="barcode-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Start Date:</label>
                    <input type="date" id="start-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Estimated Date of Submission:</label>
                    <input type="date" id="estimated-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Reminder Duration (days):</label>
                    <input type="number" id="reminder-duration" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                </div>
                <div class="md:col-span-2 border rounded-lg p-3 bg-gray-50">
                    <label class="block text-gray-700 text-sm font-bold mb-2">MRP Sticker (PDF):</label>
                    <div id="mrp-sticker-upload-section">
                        <div class="mb-2">
                            <label for="mrp-sticker-upload" class="block text-gray-600 text-xs mb-1">Upload from computer:</label>
                            <input id="mrp-sticker-upload" type="file" accept="application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                            <p id="uploading-pdf-message" class="text-blue-500 text-sm mt-2 hidden">Uploading PDF...</p>
                        </div>
                        <div class="mb-2">
                            <label for="mrp-sticker-url" class="block text-gray-600 text-xs mb-1">Or enter URL:</label>
                            <input id="mrp-sticker-url" type="text" placeholder="Enter URL for MRP sticker PDF" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        </div>
                    </div>
                    <p id="mrp-sticker-view-link" class="mt-2 hidden">
                        <a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline font-medium">
                            View Uploaded MRP Sticker
                        </a>
                    </p>
                    <p id="no-mrp-sticker-message" class="text-gray-500 text-sm mt-2 hidden">No MRP Sticker uploaded.</p>
                </div>
                <div class="md:col-span-2 border rounded-lg p-3 bg-gray-50">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Product Image:</label>
                    <div id="product-image-upload-section">
                        <div class="mb-2">
                            <label for="product-image-upload" class="block text-gray-600 text-xs mb-1">Upload from computer:</label>
                            <input id="product-image-upload" type="file" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                            <p id="uploading-image-message" class="text-blue-500 text-sm mt-2 hidden">Uploading image...</p>
                        </div>
                        <div class="mb-2">
                            <label for="product-image-url" class="block text-gray-600 text-xs mb-1">Or enter URL:</label>
                            <input id="product-image-url" type="text" placeholder="Enter URL for product image" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100">
                        </div>
                    </div>
                    <img id="product-image-preview" src="" alt="Product Preview" class="w-32 h-32 object-contain rounded-md mt-2 border border-gray-300 hidden" onerror="this.onerror=null;this.src='https://placehold.co/128x128/cccccc/000000?text=No+Img';">
                    <p id="no-product-image-message" class="text-gray-500 text-sm mt-2 hidden">No Product Image uploaded.</p>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Remarks:</label>
                    <textarea id="project-remarks" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-100 h-24 resize-y" placeholder="Add any relevant remarks here..."></textarea>
                </div>
            </div>
            <div id="reminder-status-display" class="mt-4 text-center text-lg font-medium hidden">
                Reminder Status: <span id="reminder-status-text"></span>
            </div>
            <div class="flex items-center justify-end mt-6 space-x-4">
                <button id="edit-project-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105 hidden">
                    Edit Project
                </button>
                <button id="save-project-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Save Project
                </button>
                <button id="cancel-project-modal-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="confirmation-message" class="text-lg font-semibold mb-6 text-gray-800"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-action-button" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Confirm
                </button>
                <button id="cancel-confirmation-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Passcode Modal -->
    <div id="passcode-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h2 id="passcode-modal-title" class="text-xl font-bold mb-4 text-center text-gray-800">Enter Passcode</h2>
            <p id="passcode-error" class="text-red-500 text-sm mb-4 hidden"></p>
            <div id="passcode-input-section">
                <input type="password" id="passcode-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" placeholder="Enter passcode" maxlength="4">
                <div class="flex justify-center space-x-4">
                    <button id="verify-passcode-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                        Verify
                    </button>
                    <button id="cancel-passcode-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                        Cancel
                    </button>
                </div>
                <button id="forgot-pin-button" class="mt-4 text-blue-500 hover:underline text-sm w-full text-center">
                    Forgot PIN?
                </button>
            </div>
            <div id="set-pins-section" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center text-gray-800">Set New PINs</h2>
                <p id="set-pin-error" class="text-red-500 text-sm mb-4 hidden"></p>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">New Edit PIN (4 digits):</label>
                    <input type="password" id="new-edit-pin" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" maxlength="4">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">New Delete PIN (4 digits):</label>
                    <input type="password" id="new-delete-pin" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" maxlength="4">
                </div>
                <div class="flex justify-center space-x-4">
                    <button id="save-new-pins-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                        Save New PINs
                    </button>
                    <button id="cancel-set-pins-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                        Cancel
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-4 text-center">
                    For a production app, a "Forgot PIN" feature would typically involve sending an OTP to your registered email via a secure backend service. This demo simulates a reset by allowing you to set new PINs after re-authenticating.
                </p>
            </div>
        </div>
    </div>

    <!-- Image Enlarge Modal -->
    <div id="image-enlarge-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-[100] hidden">
        <div class="relative bg-white rounded-lg shadow-xl p-4 max-w-3xl max-h-[90vh] overflow-auto">
            <button id="close-enlarge-image-button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 text-sm font-bold hover:bg-red-700 transition duration-300">
                X
            </button>
            <img id="enlarged-image" src="" alt="Enlarged Product" class="max-w-full max-h-[85vh] object-contain mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/000000?text=Image+Not+Found';">
        </div>
    </div>

    <!-- Report Options Modal -->
    <div id="report-options-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Generate Report</h2>
            <p class="text-gray-700 mb-6">
                Direct PPT export is not supported. Please choose one of the following options:
            </p>
            <div class="flex flex-col space-y-4">
                <button id="export-json-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Export Data (JSON)
                </button>
                <button id="view-printable-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    View Printable Report
                </button>
                <button id="cancel-report-options-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Printable Report View -->
    <div id="printable-report-view" class="fixed inset-0 bg-gray-100 overflow-y-auto z-50 p-4 hidden">
        <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-8 print:shadow-none print:rounded-none print:p-0">
            <div class="flex justify-between items-center mb-6 print:hidden">
                <h2 class="text-3xl font-bold text-gray-800">Printable Project Report</h2>
                <button id="print-pdf-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Print / Save as PDF
                </button>
                <button id="close-printable-report-button" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline transition duration-300 ease-in-out transform hover:scale-105">
                    Close
                </button>
            </div>

            <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-8 print:text-2xl print:mb-4">
                Product Development Report
            </h1>

            <!-- Charts Section (now with canvas for charts) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 print:grid-cols-1 print:gap-4">
                <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center print:shadow-none print:border print:border-gray-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 print:text-lg">Projects by Status</h3>
                    <div class="w-full h-[300px] flex items-center justify-center">
                        <canvas id="printable-status-chart"></canvas> <!-- New canvas for printable status chart -->
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow-md flex flex-col items-center print:shadow-none print:border print:border-gray-300">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 print:text-lg">Projects by Priority</h3>
                    <div class="w-full h-[300px] flex items-center justify-center">
                        <canvas id="printable-priority-chart"></canvas> <!-- New canvas for printable priority chart -->
                    </div>
                </div>
            </div>

            <!-- Project List for Print -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 print:text-xl">Project Details</h2>
            <div id="printable-project-list-container" class="space-y-4">
                <p class="text-center text-gray-600 text-lg py-10">No projects to display in the report.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Global Firebase instances and state variables
        let app;
        let db;
        let auth;
        let storage;
        let userId = null;
        let userEmail = null;
        let userDisplayName = null;
        let userPins = { editPin: '1234', deletePin: '2345' }; // Default PINs
        let isAuthReady = false;
        let currentProjects = [];
        let selectedProject = null;
        let isEditing = false;
        let projectToDeleteId = null;
        let passcodeActionType = ''; // 'edit' or 'delete'
        let showInitialPinSetup = false;

        // Chart instances to manage their lifecycle
        let statusChartInstance = null;
        let priorityChartInstance = null;
        // New chart instances for printable report
        let printableStatusChartInstance = null;
        let printablePriorityChartInstance = null;

        // Filter and Sort states
        let filteredStatus = null;
        let filteredPriority = null;
        let filteredCategory = 'All';
        let searchTerm = '';
        let sortOption = 'none';

        // Constants for colors
        const STATUS_COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#D32F2F'];
        const PRIORITY_COLORS = ['#E53E3E', '#DD6B20', '#38A169', '#3182CE', '#A0AEC0', '#6B46C1'];

        // Helper function to get DOM elements
        const getEl = (id) => document.getElementById(id);

        // Helper function to show/hide elements
        const showElement = (el) => el && el.classList.remove('hidden');
        const hideElement = (el) => el && el.classList.add('hidden');

        // Helper function to convert Google Drive share links to direct links
        const getGoogleDriveDirectLink = (url) => {
            if (!url || typeof url !== 'string') return url;
            const googleDriveFileIdMatch = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
            if (googleDriveFileIdMatch && googleDriveFileIdMatch[1]) {
                const fileId = googleDriveFileIdMatch[1];
                if (url.includes('image')) {
                     return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
                return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }
            return url;
        };

        // --- Core Application Logic ---

        // Function to render projects in the main list
        const renderProjects = () => {
            const container = getEl('project-list-container');
            container.innerHTML = ''; // Clear existing projects

            const projectsToDisplay = getFilteredAndSortedProjects();

            if (projectsToDisplay.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 text-lg py-10">No projects match the current filter/sort criteria.</p>';
                return;
            }

            projectsToDisplay.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-md flex flex-col justify-between transition duration-200 ease-in-out hover:shadow-lg hover:border-blue-300 cursor-pointer';
                projectCard.dataset.projectId = project.id; // Store project ID for click handling

                const reminderMessage = getReminderMessage(project);

                projectCard.innerHTML = `
                    <div class="flex-grow flex flex-col sm:flex-row items-start">
                        <div class="flex-grow">
                            <h3 class="text-xl font-bold text-blue-700 mb-2">${project.name}</h3>
                            <div class="text-sm text-gray-600 space-y-0.5">
                                ${project.projectManager ? `<p><span class="font-medium">Project Manager:</span> ${project.projectManager}</p>` : ''}
                                ${project.vendorName ? `<p><span class="font-medium">Vendor Name:</span> ${project.vendorName}</p>` : ''}
                                <p><span class="font-medium">MRP:</span> ${project.mrpCurrency} ${project.mrp}</p>
                                <p class="text-base font-semibold text-gray-700"><span class="font-medium">Estimated Submission Date:</span> ${project.estimatedDate}</p>
                                <p><span class="font-medium">Status:</span> <span class="${
                                    project.status === 'Completed' ? 'text-green-600' :
                                    project.status === 'Cancelled' ? 'text-red-600' :
                                    project.status === 'On Hold' ? 'text-yellow-600' :
                                    project.status === 'Delayed' ? 'text-red-700' :
                                    'text-blue-600'
                                }">${project.status}</span></p>
                                <p><span class="font-medium">Priority:</span> <span class="${
                                    project.priority === 'Urgent' ? 'text-red-800' :
                                    project.priority === 'High' ? 'text-orange-700' :
                                    project.priority === 'Medium-1' ? 'text-green-700' :
                                    project.priority === 'Medium-2' ? 'text-blue-700' :
                                    'text-gray-700'
                                }">${project.priority}</span></p>
                                ${project.mrpStickerUrl ? `
                                    <p>
                                        <a href="${project.mrpStickerUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline font-medium mr-2" onclick="event.stopPropagation();">
                                            View MRP Sticker (PDF)
                                        </a>
                                    </p>` : ''}
                            </div>
                        </div>
                        ${project.productImageUrl ? `
                            <div class="flex-shrink-0 mt-4 sm:mt-0 sm:ml-4">
                                <img src="${project.productImageUrl}" alt="Product" class="w-32 h-32 object-cover rounded-md cursor-pointer border border-gray-300"
                                     onclick="event.stopPropagation(); showImageEnlargeModal('${project.productImageUrl}');"
                                     onerror="this.onerror=null;this.src='https://placehold.co/128x128/cccccc/000000?text=No+Img';">
                            </div>` : ''}
                    </div>
                    <div class="flex justify-end mt-4">
                        <button class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-1.5 px-3 rounded-full shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50 delete-project-button">
                            Delete
                        </button>
                    </div>
                `;
                container.appendChild(projectCard);
            });

            // Add event listeners to newly rendered cards and delete buttons
            document.querySelectorAll('#project-list-container .cursor-pointer').forEach(card => {
                card.addEventListener('click', (event) => {
                    const projectId = event.currentTarget.dataset.projectId;
                    const project = currentProjects.find(p => p.id === projectId);
                    if (project) {
                        showProjectModal(project);
                    }
                });
            });

            document.querySelectorAll('.delete-project-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent card click
                    const projectId = event.target.closest('[data-project-id]').dataset.projectId;
                    handleDeleteProject(projectId);
                });
            });

            // Update heading based on filters
            const heading = getEl('project-list-heading');
            if (filteredStatus) {
                heading.textContent = `Projects with Status: ${filteredStatus}`;
            } else if (filteredPriority) {
                heading.textContent = `Projects with Priority: ${filteredPriority}`;
            } else if (filteredCategory !== 'All') {
                heading.textContent = `Projects in Category: ${filteredCategory}`;
            } else if (searchTerm) {
                heading.textContent = `Search Results for: "${searchTerm}"`;
            } else {
                heading.textContent = 'All Projects';
            }
        };

        // Function to get filtered and sorted projects
        const getFilteredAndSortedProjects = () => {
            let projectsSubset = [...currentProjects]; // Create a copy to avoid modifying original

            // Apply Status Filter
            if (filteredStatus) {
                projectsSubset = projectsSubset.filter(project => project.status === filteredStatus);
            }
            // Apply Priority Filter
            if (filteredPriority) {
                projectsSubset = projectsSubset.filter(project => project.priority === filteredPriority);
            }
            // Apply Category Filter
            if (filteredCategory !== 'All') {
                projectsSubset = projectsSubset.filter(project => project.category === filteredCategory);
            }
            // Apply Search Term Filter
            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                projectsSubset = projectsSubset.filter(project =>
                    project.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                    (project.projectManager && project.projectManager.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    (project.vendorName && project.vendorName.toLowerCase().includes(lowerCaseSearchTerm))
                );
            }

            // Priority order map for sorting
            const priorityOrder = {
                'Urgent': 1,
                'High': 2,
                'Medium-1': 3,
                'Medium-2': 4,
                'Low': 5,
                'Optional': 6
            };

            switch (sortOption) {
                case 'startDate':
                    projectsSubset.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    break;
                case 'submissionDate':
                    projectsSubset.sort((a, b) => new Date(a.estimatedDate) - new Date(b.estimatedDate));
                    break;
                case 'projectNumber': // Sorting by createdAt timestamp for "project number"
                    projectsSubset.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'priority':
                    projectsSubset.sort((a, b) => {
                        const priorityA = priorityOrder[a.priority] || 99; // Default to a high number if priority not found
                        const priorityB = priorityOrder[b.priority] || 99;
                        return priorityA - priorityB;
                    });
                    break;
                default:
                    // No sorting
                    break;
            }
            return projectsSubset;
        };

        // Function to render charts (using Chart.js)
        const renderCharts = () => {
            const displayed = getFilteredAndSortedProjects();
            const statusCounts = getProjectStatusCounts(displayed);
            const priorityCounts = getProjectPriorityCounts(displayed);

            // Render Status Chart
            const statusCtx = getEl('status-chart').getContext('2d');
            if (statusChartInstance) {
                statusChartInstance.destroy(); // Destroy previous chart instance if it exists
            }
            statusChartInstance = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: statusCounts.map(data => data.name),
                    datasets: [{
                        data: statusCounts.map(data => data.value),
                        backgroundColor: STATUS_COLORS,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const clickedElementIndex = elements[0].index;
                            const label = statusChartInstance.data.labels[clickedElementIndex];
                            filteredStatus = (filteredStatus === label) ? null : label; // Toggle filter
                            renderProjects();
                            renderCharts(); // Re-render charts to update based on new filter
                        }
                    }
                }
            });

            // Render Priority Chart
            const priorityCtx = getEl('priority-chart').getContext('2d');
            if (priorityChartInstance) {
                priorityChartInstance.destroy(); // Destroy previous chart instance if it exists
            }
            priorityChartInstance = new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: priorityCounts.map(data => data.name),
                    datasets: [{
                        data: priorityCounts.map(data => data.value),
                        backgroundColor: PRIORITY_COLORS,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 14
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const clickedElementIndex = elements[0].index;
                            const label = priorityChartInstance.data.labels[clickedElementIndex];
                            filteredPriority = (filteredPriority === label) ? null : label; // Toggle filter
                            renderProjects();
                            renderCharts(); // Re-render charts to update based on new filter
                        }
                    }
                }
            });
        };

        // --- Modals Logic ---

        // Project Modal
        const projectModal = getEl('project-modal');
        const projectModalTitle = getEl('project-modal-title');
        const projectModalError = getEl('project-modal-error');
        const projectNameInput = getEl('project-name');
        const projectCategorySelect = getEl('project-category');
        const vendorNameInput = getEl('vendor-name');
        const vendorPhoneInput = getEl('vendor-phone');
        const vendorAddressInput = getEl('vendor-address');
        const projectManagerInput = getEl('project-manager');
        const projectStatusSelect = getEl('project-status');
        const startDateInput = getEl('start-date');
        const estimatedDateInput = getEl('estimated-date');
        const reminderDurationInput = getEl('reminder-duration');
        const projectRemarksInput = getEl('project-remarks');
        const projectPrioritySelect = getEl('project-priority');
        const procurementCostInput = getEl('procurement-cost');
        const procurementCurrencySelect = getEl('procurement-currency');
        const mrpInput = getEl('mrp');
        const mrpCurrencySelect = getEl('mrp-currency');
        const barcodeTypeSelect = getEl('barcode-type');
        const barcodeNumberInput = getEl('barcode-number');
        const mrpStickerUrlInput = getEl('mrp-sticker-url');
        const productImageUrlInput = getEl('product-image-url');
        const mrpStickerUploadSection = getEl('mrp-sticker-upload-section');
        const productImageUploadSection = getEl('product-image-upload-section');
        const mrpStickerViewLink = getEl('mrp-sticker-view-link');
        const noMrpStickerMessage = getEl('no-mrp-sticker-message');
        const productImagePreview = getEl('product-image-preview');
        const noProductImageMessage = getEl('no-product-image-message');
        const reminderStatusDisplay = getEl('reminder-status-display');
        const reminderStatusText = getEl('reminder-status-text');
        const editProjectButton = getEl('edit-project-button');
        const saveProjectButton = getEl('save-project-button');
        const cancelProjectModalButton = getEl('cancel-project-modal-button');
        const uploadingPdfMessage = getEl('uploading-pdf-message');
        const uploadingImageMessage = getEl('uploading-image-message');
        const productSegmentSelect = getEl('product-segment');


        const barcodeTypes = [
            'EAN-13', 'UPC-A', 'Code 39', 'Code 128', 'QR Code', 'Data Matrix',
            'ITF', 'Codabar', 'GS1 DataBar', 'PDF417', 'Aztec Code'
        ];
        barcodeTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            barcodeTypeSelect.appendChild(option);
        });


        const setProjectModalFields = (project) => {
            projectNameInput.value = project?.name || '';
            projectCategorySelect.value = project?.category || 'NPD';
            vendorNameInput.value = project?.vendorName || '';
            vendorPhoneInput.value = project?.vendorPhone || '';
            vendorAddressInput.value = project?.vendorAddress || '';
            projectManagerInput.value = project?.projectManager || '';
            projectStatusSelect.value = project?.status || 'Planning';
            startDateInput.value = project?.startDate || '';
            estimatedDateInput.value = project?.estimatedDate || '';
            reminderDurationInput.value = project?.reminderDuration || 7;
            projectRemarksInput.value = project?.remarks || '';
            projectPrioritySelect.value = project?.priority || 'Medium-1';
            productSegmentSelect.value = project?.productSegment || 'Plastic Storage';
            procurementCostInput.value = project?.procurementCost || '';
            procurementCurrencySelect.value = project?.procurementCurrency || 'USD';
            mrpInput.value = project?.mrp || '';
            mrpCurrencySelect.value = project?.mrpCurrency || 'USD';
            barcodeTypeSelect.value = project?.barcodeType || 'EAN-13';
            barcodeNumberInput.value = project?.barcodeNumber || '';
            mrpStickerUrlInput.value = getGoogleDriveDirectLink(project?.mrpStickerUrl) || '';
            productImageUrlInput.value = getGoogleDriveDirectLink(project?.productImageUrl) || '';

            // Update image/pdf display
            if (mrpStickerUrlInput.value) {
                mrpStickerViewLink.href = mrpStickerUrlInput.value;
                showElement(mrpStickerViewLink);
                hideElement(noMrpStickerMessage);
            } else {
                hideElement(mrpStickerViewLink);
                showElement(noMrpStickerMessage);
            }

            if (productImageUrlInput.value) {
                productImagePreview.src = productImageUrlInput.value;
                showElement(productImagePreview);
                hideElement(noProductImageMessage);
            } else {
                hideElement(productImagePreview);
                showElement(noProductImageMessage);
            }

            // Reminder status
            if (project) {
                const status = getReminderStatus(project.estimatedDate, project.reminderDuration);
                if (status) {
                    reminderStatusText.innerHTML = status;
                    showElement(reminderStatusDisplay);
                } else {
                    hideElement(reminderStatusDisplay);
                }
            } else {
                hideElement(reminderStatusDisplay);
            }

            // Clear error
            hideElement(projectModalError);
            projectModalError.textContent = '';
        };

        const setProjectModalReadOnly = (readOnly) => {
            projectNameInput.readOnly = readOnly;
            projectCategorySelect.disabled = readOnly;
            vendorNameInput.readOnly = readOnly;
            vendorPhoneInput.readOnly = readOnly;
            vendorAddressInput.readOnly = readOnly;
            projectManagerInput.readOnly = readOnly;
            projectStatusSelect.disabled = readOnly;
            startDateInput.readOnly = readOnly;
            estimatedDateInput.readOnly = readOnly;
            reminderDurationInput.readOnly = readOnly;
            projectRemarksInput.readOnly = readOnly;
            projectPrioritySelect.disabled = readOnly;
            productSegmentSelect.disabled = readOnly;
            procurementCostInput.readOnly = readOnly;
            procurementCurrencySelect.disabled = readOnly;
            mrpInput.readOnly = readOnly;
            mrpCurrencySelect.disabled = readOnly;
            barcodeTypeSelect.disabled = readOnly;
            barcodeNumberInput.readOnly = readOnly;
            mrpStickerUrlInput.readOnly = readOnly;
            productImageUrlInput.readOnly = readOnly;

            if (readOnly) {
                hideElement(mrpStickerUploadSection);
                hideElement(productImageUploadSection);
            } else {
                showElement(mrpStickerUploadSection);
                showElement(productImageUploadSection);
            }
        };

        const showProjectModal = (project = null, editMode = false) => {
            selectedProject = project;
            isEditing = editMode;

            projectModalTitle.textContent = project ? (editMode ? 'Edit Project' : 'Project Details') : 'Add New Project';
            setProjectModalFields(project);
            setProjectModalReadOnly(project && !editMode);

            if (project && !editMode) {
                showElement(editProjectButton);
                hideElement(saveProjectButton);
                cancelProjectModalButton.textContent = 'Close';
            } else {
                hideElement(editProjectButton);
                showElement(saveProjectButton);
                cancelProjectModalButton.textContent = 'Cancel';
            }
            showElement(projectModal);
        };

        const closeProjectModal = () => {
            hideElement(projectModal);
            selectedProject = null;
            isEditing = false;
        };

        // Confirmation Modal
        const confirmationModal = getEl('confirmation-modal');
        const confirmationMessage = getEl('confirmation-message');
        let confirmCallback = null;

        const showConfirmationModal = (message, onConfirm) => {
            confirmationMessage.textContent = message;
            confirmCallback = onConfirm;
            showElement(confirmationModal);
        };

        const closeConfirmationModal = () => {
            hideElement(confirmationModal);
            confirmCallback = null;
        };

        // Passcode Modal
        const passcodeModal = getEl('passcode-modal');
        const passcodeModalTitle = getEl('passcode-modal-title');
        const passcodeError = getEl('passcode-error');
        const passcodeInputSection = getEl('passcode-input-section');
        const passcodeInput = getEl('passcode-input');
        const setPinsSection = getEl('set-pins-section');
        const newEditPinInput = getEl('new-edit-pin');
        const newDeletePinInput = getEl('new-delete-pin');
        const setPinError = getEl('set-pin-error');
        let passcodeVerifyCallback = null;

        const showPasscodeModal = (action, verifyCallback) => {
            passcodeActionType = action;
            passcodeVerifyCallback = verifyCallback;
            passcodeModalTitle.textContent = `Enter Passcode to ${action}`;
            hideElement(passcodeError);
            passcodeInput.value = '';
            hideElement(setPinsSection);
            showElement(passcodeInputSection);
            showElement(passcodeModal);
        };

        const closePasscodeModal = () => {
            hideElement(passcodeModal);
            passcodeInput.value = '';
            hideElement(passcodeError);
            hideElement(setPinsSection);
            showInitialPinSetup = false; // Reset initial setup flag
            passcodeActionType = '';
            projectToDeleteId = null;
        };

        const showSetPinsUI = () => {
            hideElement(passcodeInputSection);
            showElement(setPinsSection);
            newEditPinInput.value = '';
            newDeletePinInput.value = '';
            hideElement(setPinError);
        };

        // Image Enlarge Modal
        const imageEnlargeModal = getEl('image-enlarge-modal');
        const enlargedImage = getEl('enlarged-image');

        const showImageEnlargeModal = (imageUrl) => {
            enlargedImage.src = imageUrl;
            showElement(imageEnlargeModal);
        };

        const closeImageEnlargeModal = () => {
            hideElement(imageEnlargeModal);
            enlargedImage.src = '';
        };

        // Report Options Modal
        const reportOptionsModal = getEl('report-options-modal');

        const showReportOptionsModal = () => {
            showElement(reportOptionsModal);
        };

        const closeReportOptionsModal = () => {
            hideElement(reportOptionsModal);
        };

        // Printable Report View
        const printableReportView = getEl('printable-report-view');
        const printableStatusData = getEl('printable-status-data');
        const printablePriorityData = getEl('printable-priority-data');
        const printableProjectListContainer = getEl('printable-project-list-container');

        const showPrintableReport = () => {
            const displayed = getFilteredAndSortedProjects();
            const statusCounts = getProjectStatusCounts(displayed);
            const priorityCounts = getProjectPriorityCounts(displayed);

            // Render Printable Status Chart
            const printableStatusCtx = getEl('printable-status-chart').getContext('2d');
            if (printableStatusChartInstance) {
                printableStatusChartInstance.destroy();
            }
            printableStatusChartInstance = new Chart(printableStatusCtx, {
                type: 'pie',
                data: {
                    labels: statusCounts.map(data => data.name),
                    datasets: [{
                        data: statusCounts.map(data => data.value),
                        backgroundColor: STATUS_COLORS,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12 // Smaller font for print
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Render Printable Priority Chart
            const printablePriorityCtx = getEl('printable-priority-chart').getContext('2d');
            if (printablePriorityChartInstance) {
                printablePriorityChartInstance.destroy();
            }
            printablePriorityChartInstance = new Chart(printablePriorityCtx, {
                type: 'pie',
                data: {
                    labels: priorityCounts.map(data => data.name),
                    datasets: [{
                        data: priorityCounts.map(data => data.value),
                        backgroundColor: PRIORITY_COLORS,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12 // Smaller font for print
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.raw;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Populate printable project list
            printableProjectListContainer.innerHTML = '';
            if (displayed.length === 0) {
                printableProjectListContainer.innerHTML = '<p class="text-center text-gray-600 text-lg py-10">No projects to display in the report.</p>';
            } else {
                displayed.forEach(project => {
                    const projectDiv = document.createElement('div');
                    projectDiv.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm flex flex-col sm:flex-row print:border print:border-gray-200 print:shadow-none print:rounded-none print:p-2';
                    projectDiv.innerHTML = `
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-blue-700 mb-1 print:text-base">${project.name}</h3>
                            <div class="text-sm text-gray-600 space-y-0.5 print:text-xs">
                                ${project.projectManager ? `<p><span class="font-medium">Project Manager:</span> ${project.projectManager}</p>` : ''}
                                ${project.vendorName ? `<p><span class="font-medium">Vendor Name:</span> ${project.vendorName}</p>` : ''}
                                <p><span class="font-medium">MRP:</span> ${project.mrpCurrency} ${project.mrp}</p>
                                <p><span class="font-medium">Estimated Submission Date:</span> ${project.estimatedDate}</p>
                                <p><span class="font-medium">Status:</span> <span class="${
                                    project.status === 'Completed' ? 'text-green-600' :
                                    project.status === 'Cancelled' ? 'text-red-600' :
                                    project.status === 'On Hold' ? 'text-yellow-600' :
                                    project.status === 'Delayed' ? 'text-red-700' :
                                    'text-blue-600'
                                }">${project.status}</span></p>
                                <p><span class="font-medium">Priority:</span> <span class="${
                                    project.priority === 'Urgent' ? 'text-red-800' :
                                    project.priority === 'High' ? 'text-orange-700' :
                                    project.priority === 'Medium-1' ? 'text-green-700' :
                                    project.priority === 'Medium-2' ? 'text-blue-700' :
                                    'text-gray-700'
                                }">${project.priority}</span></p>
                                ${project.mrpStickerUrl ? `
                                    <p>
                                        <a href="${project.mrpStickerUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline font-medium">
                                            View MRP Sticker (PDF)
                                        </a>
                                    </p>` : ''}
                                ${project.remarks ? `<p><span class="font-medium">Remarks:</span> ${project.remarks}</p>` : ''}
                            </div>
                        </div>
                        ${project.productImageUrl ? `
                            <div class="flex-shrink-0 mt-4 sm:mt-0 sm:ml-4 print:ml-2">
                                <img src="${project.productImageUrl}" alt="Product" class="w-24 h-24 object-cover rounded-md border border-gray-300 print:w-20 print:h-20"
                                     onerror="this.onerror=null;this.src='https://placehold.co/96x96/cccccc/000000?text=No+Img';">
                            </div>` : ''}
                    `;
                    printableProjectListContainer.appendChild(projectDiv);
                });
            }

            showElement(printableReportView);
        };

        const closePrintableReport = () => {
            hideElement(printableReportView);
            // Destroy printable chart instances when closing the report view
            if (printableStatusChartInstance) {
                printableStatusChartInstance.destroy();
                printableStatusChartInstance = null;
            }
            if (printablePriorityChartInstance) {
                printablePriorityChartInstance.destroy();
                printablePriorityChartInstance = null;
            }
        };


        // --- Firebase Operations ---

        // Firebase Initialization
        const initializeFirebase = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Cannot initialize Firebase.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userEmail = user.email;
                        userDisplayName = user.displayName;
                        isAuthReady = true;
                        getEl('user-id').textContent = userId;
                        getEl('user-display-name').textContent = userDisplayName || userEmail;
                        showElement(getEl('user-email-display'));
                        getEl('auth-button').textContent = 'Sign Out';
                        showElement(getEl('change-pins-button'));
                        await fetchUserPins(userId);
                        fetchProjects(); // Fetch projects after auth is ready
                    } else {
                        userId = null;
                        userEmail = null;
                        userDisplayName = null;
                        isAuthReady = false;
                        getEl('user-id').textContent = 'Not logged in';
                        hideElement(getEl('user-email-display'));
                        getEl('auth-button').textContent = 'Sign In with Google';
                        hideElement(getEl('change-pins-button'));
                        currentProjects = []; // Clear projects on sign out
                        renderProjects(); // Re-render to show empty state
                        renderCharts(); // Re-render charts
                        // Sign in anonymously if you want to keep data for anonymous users
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        };

        // Fetch user-specific PINs
        const fetchUserPins = async (uid) => {
            if (!uid || !db) return;
            const userSettingsRef = doc(db, `artifacts/${__app_id}/users/${uid}/settings/pins`);
            try {
                const docSnap = await getDoc(userSettingsRef);
                if (docSnap.exists()) {
                    userPins = docSnap.data();
                    showInitialPinSetup = false;
                } else {
                    showInitialPinSetup = true;
                    showPasscodeModal('setup', () => {}); // Show PIN setup modal
                }
            } catch (error) {
                console.error("Error fetching user pins:", error);
            }
        };

        // Save user-specific PINs
        const saveUserPins = async (editPin, deletePin) => {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                return;
            }
            const userSettingsRef = doc(db, `artifacts/${__app_id}/users/${userId}/settings/pins`);
            try {
                await setDoc(userSettingsRef, { editPin, deletePin }, { merge: true });
                userPins = { editPin, deletePin };
                console.log("User PINs saved successfully.");
            } catch (error) {
                console.error("Error saving user pins:", error);
            }
        };

        // Google Sign-In handler
        const handleGoogleSignIn = async () => {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google Sign-In:", error);
            }
        };

        // Sign Out handler
        const handleSignOut = async () => {
            if (!auth) return;
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        };

        // Handle Forgot PIN flow
        const handleForgotPin = async () => {
            if (!auth || !auth.currentUser) {
                console.error("No authenticated user to reset PIN for.");
                return;
            }
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // If re-authentication is successful, allow setting new pins
                showSetPinsUI();
            } catch (error) {
                console.error("Error during re-authentication for PIN reset:", error);
                // alert("Failed to re-authenticate. Please try again or contact support if this persists.");
                passcodeError.textContent = "Failed to re-authenticate. Please try again.";
                showElement(passcodeError);
            }
        };

        // Fetch projects from Firestore
        const fetchProjects = () => {
            if (!db || !userId) {
                console.warn("Firestore not initialized or user not authenticated. Cannot fetch projects.");
                return;
            }
            const projectsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
            onSnapshot(projectsCollectionRef, (snapshot) => {
                const projectsData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                currentProjects = projectsData.map(project => ({
                    ...project,
                    mrpStickerUrl: getGoogleDriveDirectLink(project.mrpStickerUrl),
                    productImageUrl: getGoogleDriveDirectLink(project.productImageUrl)
                }));
                renderProjects();
                renderCharts();
            }, (error) => {
                console.error("Error fetching projects:", error);
            });
        };

        // Add/Update Project
        const saveProject = async () => {
            const projectData = {
                name: projectNameInput.value,
                category: projectCategorySelect.value,
                vendorName: vendorNameInput.value,
                vendorPhone: vendorPhoneInput.value,
                vendorAddress: vendorAddressInput.value,
                projectManager: projectManagerInput.value,
                status: projectStatusSelect.value,
                startDate: startDateInput.value,
                estimatedDate: estimatedDateInput.value,
                reminderDuration: parseInt(reminderDurationInput.value, 10) || 0,
                remarks: projectRemarksInput.value,
                priority: projectPrioritySelect.value,
                productSegment: productSegmentSelect.value,
                procurementCost: parseFloat(procurementCostInput.value) || 0,
                procurementCurrency: procurementCurrencySelect.value,
                mrp: parseFloat(mrpInput.value) || 0,
                mrpCurrency: mrpCurrencySelect.value,
                barcodeType: barcodeTypeSelect.value,
                barcodeNumber: barcodeNumberInput.value,
                mrpStickerUrl: mrpStickerUrlInput.value,
                productImageUrl: productImageUrlInput.value,
            };

            if (!projectData.name || !projectData.startDate || !projectData.estimatedDate) {
                projectModalError.textContent = 'Project Name, Start Date, and Estimated Date are required.';
                showElement(projectModalError);
                return;
            }

            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated.");
                return;
            }

            try {
                if (selectedProject && isEditing) {
                    // Update existing project
                    const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, selectedProject.id);
                    await updateDoc(projectDocRef, { ...projectData, updatedAt: new Date().toISOString() });
                } else {
                    // Add new project
                    const projectsCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/projects`);
                    await addDoc(projectsCollectionRef, { ...projectData, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString() });
                }
                closeProjectModal();
            } catch (e) {
                console.error("Error saving document: ", e);
                projectModalError.textContent = `Error saving project: ${e.message}`;
                showElement(projectModalError);
            }
        };

        // Delete Project
        const handleDeleteProject = (id) => {
            projectToDeleteId = id;
            showConfirmationModal("Are you sure you want to delete this project?", () => {
                showPasscodeModal('delete', async () => {
                    if (!db || !userId || !projectToDeleteId) {
                        console.error("Firestore not initialized or project ID missing for deletion.");
                        return;
                    }
                    try {
                        const projectDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/projects`, projectToDeleteId);
                        await deleteDoc(projectDocRef);
                        projectToDeleteId = null;
                        closePasscodeModal();
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                        passcodeError.textContent = `Error deleting project: ${e.message}`;
                        showElement(passcodeError);
                    }
                });
            });
        };

        // Upload File to Storage
        const uploadFile = async (file, folderName) => {
            if (!storage || !userId) {
                projectModalError.textContent = "Firebase Storage not initialized or user not authenticated.";
                showElement(projectModalError);
                return null;
            }
            const projectIdForPath = selectedProject?.id || crypto.randomUUID(); // Use existing ID or new UUID
            const filePath = `artifacts/${__app_id}/users/${userId}/${folderName}/${projectIdForPath}/${file.name}`;
            const fileRef = ref(storage, filePath);
            try {
                const snapshot = await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (uploadError) {
                console.error("Error uploading file:", uploadError);
                projectModalError.textContent = `Failed to upload file: ${uploadError.message}`;
                showElement(projectModalError);
                return null;
            }
        };

        // Handle Product Image Upload
        const handleProductImageUpload = async (e) => {
            const file = e.target.files[0];
            if (file) {
                showElement(uploadingImageMessage);
                hideElement(projectModalError);
                const url = await uploadFile(file, 'product_images');
                if (url) {
                    productImageUrlInput.value = url;
                    productImagePreview.src = url;
                    showElement(productImagePreview);
                    hideElement(noProductImageMessage);
                }
                hideElement(uploadingImageMessage);
                e.target.value = null; // Clear the input
            }
        };

        // Handle MRP Sticker Upload
        const handleMrpStickerUpload = async (e) => {
            const file = e.target.files[0];
            if (file) {
                showElement(uploadingPdfMessage);
                hideElement(projectModalError);
                const url = await uploadFile(file, 'mrp_stickers');
                if (url) {
                    mrpStickerUrlInput.value = url;
                    mrpStickerViewLink.href = url;
                    showElement(mrpStickerViewLink);
                    hideElement(noMrpStickerMessage);
                }
                hideElement(uploadingPdfMessage);
                e.target.value = null; // Clear the input
            }
        };

        // Helper for reminder message
        const getReminderMessage = (project) => {
            if (!project.estimatedDate || !project.reminderDuration) return null;

            const estimated = new Date(project.estimatedDate);
            const today = new Date();
            const reminderThreshold = new Date(estimated.getTime());
            reminderThreshold.setDate(estimated.getDate() - project.reminderDuration);

            today.setHours(0, 0, 0, 0);
            estimated.setHours(0, 0, 0, 0);
            reminderThreshold.setHours(0, 0, 0, 0);

            if (today.getTime() === estimated.getTime()) {
                return `<span class="text-purple-600 font-semibold">Due Today!</span>`;
            } else if (today > estimated) {
                return `<span class="text-red-600 font-semibold">Overdue!</span>`;
            } else if (today >= reminderThreshold) {
                const daysLeft = Math.ceil((estimated.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                return `<span class="text-orange-500 font-semibold">Due in ${daysLeft} days!</span>`;
            }
            return null;
        };

        // Helper for status counts
        const getProjectStatusCounts = (projs) => {
            const counts = {};
            projs.forEach(project => {
                counts[project.status] = (counts[project.status] || 0) + 1;
            });
            return Object.keys(counts).map(status => ({
                name: status,
                value: counts[status]
            }));
        };

        // Helper for priority counts
        const getProjectPriorityCounts = (projs) => {
            const counts = {};
            projs.forEach(project => {
                counts[project.priority] = (counts[project.priority] || 0) + 1;
            });
            return Object.keys(counts).map(priority => ({
                name: priority,
                value: counts[priority]
            }));
        };


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

        getEl('add-project-button').addEventListener('click', () => showProjectModal());
        getEl('create-report-button').addEventListener('click', showReportOptionsModal);

        // Project Modal Buttons
        getEl('edit-project-button').addEventListener('click', () => {
            showPasscodeModal('edit', () => {
                isEditing = true;
                setProjectModalReadOnly(false);
                hideElement(editProjectButton);
                showElement(saveProjectButton);
                cancelProjectModalButton.textContent = 'Cancel';
                closePasscodeModal(); // Close passcode modal after successful verification
            });
        });
        getEl('save-project-button').addEventListener('click', saveProject);
        getEl('cancel-project-modal-button').addEventListener('click', closeProjectModal);

        // Confirmation Modal Buttons
        getEl('confirm-action-button').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmationModal();
        });
        getEl('cancel-confirmation-button').addEventListener('click', closeConfirmationModal);

        // Passcode Modal Buttons
        getEl('verify-passcode-button').addEventListener('click', () => {
            const enteredPasscode = passcodeInput.value;
            const correctPin = passcodeActionType === 'delete' ? userPins.deletePin : userPins.editPin;

            if (enteredPasscode === correctPin) {
                if (passcodeVerifyCallback) {
                    passcodeVerifyCallback();
                }
                closePasscodeModal();
            } else {
                passcodeError.textContent = 'Incorrect passcode. Please try again.';
                showElement(passcodeError);
            }
        });
        getEl('cancel-passcode-button').addEventListener('click', closePasscodeModal);
        getEl('forgot-pin-button').addEventListener('click', handleForgotPin);
        getEl('save-new-pins-button').addEventListener('click', () => {
            const newEdit = newEditPinInput.value;
            const newDelete = newDeletePinInput.value;
            if (newEdit.length === 4 && newDelete.length === 4 && /^\d+$/.test(newEdit) && /^\d+$/.test(newDelete)) {
                saveUserPins(newEdit, newDelete);
                closePasscodeModal();
            } else {
                setPinError.textContent = 'Both PINs must be 4-digit numbers.';
                showElement(setPinError);
            }
        });
        getEl('cancel-set-pins-button').addEventListener('click', closePasscodeModal); // Same as cancel passcode modal

        // Image/PDF Upload Handlers
        getEl('product-image-upload').addEventListener('change', handleProductImageUpload);
        getEl('mrp-sticker-upload').addEventListener('change', handleMrpStickerUpload);
        getEl('product-image-url').addEventListener('input', (e) => {
            const url = getGoogleDriveDirectLink(e.target.value);
            productImagePreview.src = url;
            if (url) {
                showElement(productImagePreview);
                hideElement(noProductImageMessage);
            } else {
                hideElement(productImagePreview);
                showElement(noProductImageMessage);
            }
        });
        getEl('mrp-sticker-url').addEventListener('input', (e) => {
            const url = getGoogleDriveDirectLink(e.target.value);
            mrpStickerViewLink.href = url;
            if (url) {
                showElement(mrpStickerViewLink);
                hideElement(noMrpStickerMessage);
            } else {
                hideElement(mrpStickerViewLink);
                showElement(noMrpStickerMessage);
            }
        });

        // Image Enlarge Modal Button
        getEl('close-enlarge-image-button').addEventListener('click', closeImageEnlargeModal);

        // Report Options Modal Buttons
        getEl('export-json-button').addEventListener('click', () => {
            const dataToExport = getFilteredAndSortedProjects().map(project => ({
                ...project,
                id: undefined,
                createdAt: undefined,
                updatedAt: undefined
            }));
            const jsonString = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'product_development_report.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            closeReportOptionsModal();
        });
        getEl('view-printable-button').addEventListener('click', () => {
            closeReportOptionsModal();
            showPrintableReport();
        });
        getEl('cancel-report-options-button').addEventListener('click', closeReportOptionsModal);

        // Printable Report View Buttons
        getEl('print-pdf-button').addEventListener('click', () => {
            console.log("Print button clicked, attempting window.print()");
            window.print();
        });
        getEl('close-printable-report-button').addEventListener('click', closePrintableReport);

        // Filter and Sort Event Listeners
        getEl('category-filter').addEventListener('change', (e) => {
            filteredCategory = e.target.value;
            renderProjects();
            renderCharts();
        });
        getEl('search-projects').addEventListener('input', (e) => {
            searchTerm = e.target.value;
            renderProjects();
            renderCharts();
        });
        getEl('sort-by').addEventListener('change', (e) => {
            sortOption = e.target.value;
            renderProjects();
        });
        getEl('clear-status-filter').addEventListener('click', () => {
            filteredStatus = null;
            renderProjects();
            renderCharts();
        });
        getEl('clear-priority-filter').addEventListener('click', () => {
            filteredPriority = null;
            renderProjects();
            renderCharts();
        });

        // Initial render (will be updated by fetchProjects)
        renderProjects();
        renderCharts();

    </script>
</body>
</html>
